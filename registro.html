<!DOCTYPE html> 
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registro para obtener tu premio</title>
  <link rel="stylesheet" href="styles.css"/>

  <style>
    :root{
      --card-bg:#23272f; --card-br:18px; --shadow-soft:0 2px 12px rgba(0,0,0,.12);
      --gris-200:#e5e7eb; --gris-300:#d1d5db; --gris-600:#4b5563; --gris-700:#374151;
      --fucsia:#e6007a; --turquesa:#00c9b7; --error:#ef4444; --ok:#10b981;
    }
    body{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      min-height:100vh; padding:30px; background:#181a20; color:#fff;
    }
    .registro-container{
      background:var(--card-bg); border-radius:var(--card-br); box-shadow:var(--shadow-soft);
      padding:24px 22px 26px; width:100%; max-width:520px; border:1px solid var(--gris-300);
    }

    /* ‚Äî‚Äî‚Äî Logo responsive ‚Äî‚Äî‚Äî */
    .logo-wrap{ display:flex; justify-content:center; margin-bottom:10px; }
    .brand-logo{
      /* ancho flexible: chico en m√≥vil, m√°s grande en desktop */
      width: clamp(120px, 42vw, 220px);
      max-width: 70%;
      height: auto;                 /* mantiene proporci√≥n */
      display:block;
      image-rendering:-webkit-optimize-contrast;
      -ms-interpolation-mode: bicubic;
      filter: drop-shadow(0 2px 8px rgba(0,0,0,.35));
    }
    /* Opcional: pon la clase 'badge' si tu logo pierde contraste en fondo oscuro */
    .brand-logo.badge{
      background:#fff;
      border-radius:12px;
      padding:6px 10px;
    }

    h2{ text-align:center; margin:8px 0 14px; color:var(--fucsia); line-height:1.2; }
    p.lead{ text-align:center; margin:0 0 18px; color:#cbd5e1; }

    .form-group{ margin-bottom:18px; }
    .form-group label{ font-weight:700; display:block; margin-bottom:8px; color:#e5e7eb; }
    .form-group input{
      width:100%; padding:12px; border-radius:10px; border:1px solid var(--gris-300);
      font-size:16px; background:#0f1218; color:#fff; outline:none;
    }
    .form-group input:focus{ border-color:var(--turquesa); box-shadow:0 0 0 3px rgba(0,201,183,.2); }
    .hint{ font-size:.85rem; color:#9ca3af; margin-top:6px; }
    .error-msg{ font-size:.85rem; color:var(--error); margin-top:6px; display:none; }
    .is-invalid{ border-color:var(--error) !important; box-shadow:0 0 0 3px rgba(239,68,68,.2) !important; }

    .submit-btn{
      background:linear-gradient(90deg, var(--turquesa), var(--fucsia));
      color:#fff; font-weight:800; padding:14px; border:0; border-radius:12px;
      width:100%; cursor:pointer; font-size:18px; transition:opacity .2s, transform .02s;
    }
    .submit-btn:active{ transform:scale(.995); }
    .submit-btn[disabled]{ opacity:.6; cursor:not-allowed; }

    /* Ajustes muy peque√±os (tel√©fonos angostos) */
    @media (max-width: 360px){
      .registro-container{ padding:18px 16px 22px; }
      h2{ font-size:1.15rem; }
      .brand-logo{ width: clamp(110px, 50vw, 180px); }
    }
  </style>
</head>
<body>
  <div class="registro-container">
    <!-- Logo -->
    <div class="logo-wrap">
      <!-- Si necesitas m√°s contraste, agrega la clase 'badge' abajo -->
      <img src="./logo-much.png" alt="MUCH ¬∑ Museo de Ciencia y Tecnolog√≠a" class="brand-logo">
    </div>

    <h2> Reg√≠strate para reclamar tu premio üêÜ</h2>
    <p class="lead">Gracias por Visitar el MUCH</p>

    <form id="registroForm" autocomplete="off" novalidate>
      <!-- Nombre -->
      <div class="form-group">
        <label for="nombre">Nombre completo</label>
        <input
          type="text" id="nombre" name="nombre" required
          inputmode="text" minlength="6" maxlength="80"
          placeholder="Ej. Celi Glescanni"
          title="Escribe tu nombre completo (m√≠nimo 2 palabras)."
        />
        <div class="hint">Usa al menos dos palabras. Se permiten acentos y espacios.</div>
        <div class="error-msg" id="err-nombre"></div>
      </div>

      <!-- Correo -->
      <div class="form-group">
        <label for="correo">Correo electr√≥nico</label>
        <input
          type="email" id="correo" name="correo" required
          inputmode="email" maxlength="120" placeholder="tucorreo@dominio.com"
          autocomplete="email"
        />
        <div class="hint">Debe ser un correo v√°lido (evita temporales).</div>
        <div class="error-msg" id="err-correo"></div>
      </div>

      <!-- Tel√©fono -->
      <div class="form-group">
        <label for="telefono">N√∫mero de tel√©fono</label>
        <input
          type="tel" id="telefono" name="telefono" required
          inputmode="numeric" pattern="[0-9]{10}" maxlength="10"
          placeholder="Agrega 10 d√≠gitos"
          title="Solo n√∫meros, de 10 d√≠gitos."
        />
        <div class="hint">Solo 10 d√≠gitos.</div>
        <div class="error-msg" id="err-telefono"></div>
      </div>

      <button type="submit" id="submitBtn" class="submit-btn">Obtener mi Boleto</button>
    </form>
  </div>

  <script>
    // ---------- Validadores ----------
    const reNombre = /^[A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√±]+(?:[ \t]+[A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√±'.-]+){1,}$/; // ‚â•2 palabras
    const reEmail  = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;
    const rePhone  = /^\d{10}$/;
    const disposableDomains = ["10minutemail.com","guerrillamail.com","tempmail.com","yopmail.com","mailinator.com","trashmail.com","sharklasers.com"];
    const $ = (id) => document.getElementById(id);

    function setError(inputEl, errEl, msg){ inputEl.classList.add('is-invalid'); errEl.textContent = msg; errEl.style.display = 'block'; }
    function clearError(inputEl, errEl){ inputEl.classList.remove('is-invalid'); errEl.textContent = ''; errEl.style.display = 'none'; }

    function validateNombre(raw){
      const nombre = raw.trim().replace(/\s+/g,' ');
      if (nombre.length < 6) return "Es muy corto. Escribe tu nombre completo.";
      if (!reNombre.test(nombre)) return "Escribe al menos nombre y apellido (solo letras y espacios).";
      return null;
    }
    function validateEmail(raw){
      const email = raw.trim().toLowerCase();
      if (!reEmail.test(email)) return "Correo no v√°lido.";
      const domain = email.split('@')[1] || '';
      if (disposableDomains.includes(domain)) return "Este dominio de correo no es permitido.";
      return null;
    }
    function validatePhone(raw){
      const tel = raw.trim();
      if (!rePhone.test(tel)) return "El tel√©fono debe tener 10 d√≠gitos.";
      return null;
    }

    // ---------- Submit ----------
    let submitting = false;

    // üîÑ la volvemos async para poder esperar Supabase
    $('registroForm').addEventListener('submit', async function(e){
      e.preventDefault();
      if (submitting) return;
      submitting = true;
      $('submitBtn').setAttribute('disabled','disabled');

      const nombre   = $('nombre').value;
      const correo   = $('correo').value;
      const telefono = $('telefono').value;

      // Validar campos
      let ok = true;
      const nErr = validateNombre(nombre);  if (nErr){ ok=false; setError($('nombre'), $('err-nombre'), nErr); } else { clearError($('nombre'), $('err-nombre')); }
      const cErr = validateEmail(correo);   if (cErr){ ok=false; setError($('correo'), $('err-correo'), cErr); } else { clearError($('correo'), $('err-correo')); }
      const tErr = validatePhone(telefono); if (tErr){ ok=false; setError($('telefono'), $('err-telefono'), tErr); } else { clearError($('telefono'), $('err-telefono')); }

      if (!ok){
        submitting = false;
        $('submitBtn').removeAttribute('disabled');
        return;
      }

      // Intentar leer el premio que dej√≥ el juego (much_quiz_prize)
      let prizeData = null;
      try{
        const raw = localStorage.getItem('much_quiz_prize');
        if (raw) prizeData = JSON.parse(raw);
      }catch(_){}

      // Plan B
      if (!prizeData){
        const folio = 'MUCH-' + Math.random().toString(36).substring(2,8).toUpperCase();
        prizeData = {
          title: 'MUCH ¬∑ Premio',
          label: 'Entrada al Planetario MUCH',
          lugar: 'Planetario MUCH',
          folio: folio,
          date: new Date().toISOString(),
          emoji: 'üéÅ'
        };
        try { localStorage.setItem('much_quiz_prize', JSON.stringify(prizeData)); } catch(_){}
      }

      const nombreLimpio = nombre.trim().replace(/\s+/g,' ');
      const correoLimpio = correo.trim().toLowerCase();
      const telLimpio    = telefono.trim();

      // Primero intentamos guardar en Supabase (si la funci√≥n global existe)
      try{
        if (window.saveRegistroToSupabase){
          await window.saveRegistroToSupabase({
            nombre: nombreLimpio,
            correo: correoLimpio,
            telefono: telLimpio,
            premio: prizeData.label || '',
            folio:  prizeData.folio || ''
          });
        }
      }catch(_){}

      // Build params
      const params = new URLSearchParams({
        nombre:   nombreLimpio,
        correo:   correoLimpio,
        telefono: telLimpio,
        premio:   prizeData.label || '',
        folio:    prizeData.folio || '',
        lugar:    prizeData.lugar || ''
      });

      // Evitar doble canje
      try { localStorage.removeItem('much_quiz_prize'); } catch(_){}

      window.location.href = 'boleto.html?' + params.toString();
    });

    // Limpieza de errores
    ['nombre','correo','telefono'].forEach(id=>{
      $(id).addEventListener('input', () => {
        const map = {
          nombre:  [validateNombre, $('err-nombre')],
          correo:  [validateEmail,  $('err-correo')],
          telefono:[validatePhone,  $('err-telefono')]
        };
        const [fn, errEl] = map[id];
        const msg = fn($(id).value);
        if (msg) setError($(id), errEl, msg); else clearError($(id), errEl);
      });
    });
  </script>

  <!-- ‚úÖ Nuevo: Supabase para participantes + boletos -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = 'https://qwgaeorsymfispmtsbut.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3Z2Flb3JzeW1maXNwbXRzYnV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzODcyODUsImV4cCI6MjA3Nzk2MzI4NX0.FThZIIpz3daC9u8QaKyRTpxUeW0v4QHs5sHX2s1U1eo';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function upsertParticipante(nombre, correo, telefono){
      try{
        let { data, error } = await supabase
          .from('participantes')
          .select('id')
          .eq('correo', correo)
          .limit(1);

        if (!error && data && data.length){
          return data[0].id;
        }

        ({ data, error } = await supabase
          .from('participantes')
          .insert({ nombre, correo, telefono })
          .select('id')
          .single());

        if (error){
          console.warn('Error insertando participante:', error.message);
          return null;
        }
        return data?.id || null;
      }catch(e){
        console.warn('upsertParticipante error:', e?.message || e);
        return null;
      }
    }

    function addDays(date, days){
      return new Date(date.getTime() + days*24*60*60*1000);
    }

    async function getPremioId(premioLabel){
      try{
        let query = supabase.from('premios').select('id, nombre, tipo').limit(1);

        const lower = (premioLabel || '').toLowerCase();
        if (lower.includes('planetario')){
          query = query.eq('tipo','planetario');
        }else if (lower.includes('museo')){
          query = query.eq('tipo','museo');
        }else if (premioLabel){
          query = query.ilike('nombre', premioLabel);
        }

        const { data, error } = await query;
        if (error){
          console.warn('Error buscando premio:', error.message);
          return null;
        }
        if (data && data.length) return data[0].id;
        return null;
      }catch(e){
        console.warn('getPremioId error:', e?.message || e);
        return null;
      }
    }

    async function crearBoleto({ participante_id, folio, premioLabel }){
      if (!participante_id || !folio) return;
      try{
        // si ya existe el folio, no duplicamos
        let { data, error } = await supabase
          .from('boletos')
          .select('id')
          .eq('folio', folio)
          .limit(1);

        if (!error && data && data.length){
          return;
        }

        const hoy = new Date();
        const desde = hoy.toISOString().slice(0,10);
        const hasta = addDays(hoy, 7).toISOString().slice(0,10);

        const premio_id = await getPremioId(premioLabel);

        const payload = {
          participante_id,
          folio,
          valido_desde: desde,
          valido_hasta: hasta
        };

        if (premio_id) payload.premio_id = premio_id;

        ({ error } = await supabase.from('boletos').insert(payload));
        if (error) console.warn('Error creando boleto:', error.message);
      }catch(e){
        console.warn('crearBoleto error:', e?.message || e);
      }
    }

    // Exponer una funci√≥n global que el script de arriba pueda usar
    window.saveRegistroToSupabase = async function({ nombre, correo, telefono, premio, folio }){
      const participante_id = await upsertParticipante(nombre, correo, telefono);
      await crearBoleto({ participante_id, folio, premioLabel: premio });
    };
  </script>
</body>
</html>

